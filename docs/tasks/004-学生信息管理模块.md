# 任务 004: 学生信息管理模块

## 一、任务概述

**任务名称**：学生信息管理模块
**优先级**：P0（核心功能）
**预估工作量**：6-8小时
**任务类型**：业务功能

## 二、任务目标

实现学生信息的完整管理功能，包括 CRUD 操作、批量导入导出、数据验证、搜索过滤等核心功能。

## 三、功能清单

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 学生列表展示 | P0 | 表格展示学生信息 |
| 添加学生 | P0 | 单个学生添加 |
| 编辑学生 | P0 | 修改学生信息 |
| 删除学生 | P0 | 删除学生（含确认） |
| 批量删除 | P1 | 批量删除多个学生 |
| 批量导入 | P1 | CSV/Excel 文件导入 |
| 数据导出 | P1 | 导出学生清单 |
| 搜索过滤 | P1 | 按姓名、性别等条件搜索 |
| 数据验证 | P0 | 姓名唯一性等验证 |
| 统计信息 | P2 | 男生/女生数量统计 |

## 四、实施步骤

### 步骤 1: 创建 StudentRepository

#### 1.1 创建 `src/repository/student.repository.ts`

```typescript
// src/repository/student.repository.ts
import Database from 'better-sqlite3'
import { BaseRepository } from './base-repository'
import type { Student, CreateStudentDto, UpdateStudentDto, StudentQueryParams } from '@/types'

export class StudentRepository extends BaseRepository<Student> {
  constructor(db: Database.Database) {
    super('students')
    this.db = db
  }

  /**
   * 将数据库行映射为学生实体
   */
  protected mapToEntity(row: any): Student {
    return {
      id: row.id,
      name: row.name,
      gender: row.gender,
      contact: row.contact,
      grade: row.grade,
      className: row.class_name,
      specialNeeds: row.special_needs === 1,
      preferredSeatId: row.preferred_seat_id,
      notes: row.notes,
      createdAt: row.created_at,
      updatedAt: row.updated_at
    }
  }

  /**
   * 根据姓名查找学生
   */
  findByName(name: string): Student | null {
    const stmt = this.db.prepare('SELECT * FROM students WHERE name = ?')
    const row = stmt.get(name)
    return row ? this.mapToEntity(row) : null
  }

  /**
   * 根据性别查找学生
   */
  findByGender(gender: 'male' | 'female'): Student[] {
    const stmt = this.db.prepare('SELECT * FROM students WHERE gender = ?')
    const rows = stmt.all(gender) as any[]
    return rows.map(row => this.mapToEntity(row))
  }

  /**
   * 根据班级查找学生
   */
  findByClass(className: string): Student[] {
    const stmt = this.db.prepare('SELECT * FROM students WHERE class_name = ?')
    const rows = stmt.all(className) as any[]
    return rows.map(row => this.mapToEntity(row))
  }

  /**
   * 查询学生（支持多条件）
   */
  query(params: StudentQueryParams): Student[] {
    let sql = 'SELECT * FROM students WHERE 1=1'
    const conditions: string[] = []
    const values: any[] = []

    if (params.gender) {
      conditions.push('gender = ?')
      values.push(params.gender)
    }

    if (params.grade) {
      conditions.push('grade = ?')
      values.push(params.grade)
    }

    if (params.className) {
      conditions.push('class_name = ?')
      values.push(params.className)
    }

    if (params.specialNeeds !== undefined) {
      conditions.push('special_needs = ?')
      values.push(params.specialNeeds ? 1 : 0)
    }

    if (params.keyword) {
      conditions.push('(name LIKE ? OR contact LIKE ? OR notes LIKE ?)')
      const keyword = `%${params.keyword}%`
      values.push(keyword, keyword, keyword)
    }

    if (conditions.length > 0) {
      sql += ' AND ' + conditions.join(' AND ')
    }

    const stmt = this.db.prepare(sql)
    const rows = stmt.all(...values) as any[]
    return rows.map(row => this.mapToEntity(row))
  }

  /**
   * 统计学生数量
   */
  count(): number {
    const stmt = this.db.prepare('SELECT COUNT(*) as count FROM students')
    const result = stmt.get() as { count: number }
    return result.count
  }

  /**
   * 按性别统计
   */
  countByGender(): { male: number; female: number } {
    const stmt = this.db.prepare(`
      SELECT gender, COUNT(*) as count
      FROM students
      GROUP BY gender
    `)
    const rows = stmt.all() as Array<{ gender: string; count: number }>

    const result = { male: 0, female: 0 }
    for (const row of rows) {
      if (row.gender === 'male') result.male = row.count
      if (row.gender === 'female') result.female = row.count
    }

    return result
  }

  /**
   * 批量插入学生
   */
  batchInsert(students: CreateStudentDto[]): number {
    let count = 0
    const transaction = this.db.transaction(() => {
      for (const student of students) {
        try {
          this.insert(student)
          count++
        } catch (error) {
          console.error('插入学生失败:', student.name, error)
        }
      }
    })

    transaction()
    return count
  }
}
```

### 步骤 2: 创建 StudentManager

#### 2.1 创建 `src/core/student-manager.ts`

```typescript
// src/core/student-manager.ts
import type {
  Student,
  CreateStudentDto,
  UpdateStudentDto,
  StudentQueryParams,
  ImportResult,
  ValidationResult
} from '@/types'
import { v4 as uuidv4 } from 'uuid'

export class StudentManager {
  /**
   * 添加学生
   */
  async addStudent(dto: CreateStudentDto): Promise<Student> {
    // 1. 数据验证
    const validation = this.validateStudent(dto)
    if (!validation.valid) {
      throw new Error(validation.errors.join(', '))
    }

    // 2. 检查姓名唯一性
    // const exists = await this.repository.findByName(dto.name)
    // if (exists) {
    //   throw new Error(`学生姓名 "${dto.name}" 已存在`)
    // }

    // 3. 创建学生实体
    const now = new Date().toISOString()
    const student: Student = {
      id: uuidv4(),
      ...dto,
      specialNeeds: dto.specialNeeds || false,
      createdAt: now,
      updatedAt: now
    }

    // 4. 保存到数据库
    // await this.repository.insert(student)

    return student
  }

  /**
   * 更新学生
   */
  async updateStudent(id: string, dto: UpdateStudentDto): Promise<Student> {
    // 1. 查找学生
    // const student = await this.repository.findById(id)
    // if (!student) {
    //   throw new Error('学生不存在')
    // }

    // 2. 如果修改姓名，检查唯一性
    // if (dto.name && dto.name !== student.name) {
    //   const exists = await this.repository.findByName(dto.name)
    //   if (exists) {
    //     throw new Error(`学生姓名 "${dto.name}" 已存在`)
    //   }
    // }

    // 3. 更新学生
    // await this.repository.update(id, dto)

    // return await this.repository.findById(id)!
    return {} as Student
  }

  /**
   * 删除学生
   */
  async deleteStudent(id: string): Promise<void> {
    // const student = await this.repository.findById(id)
    // if (!student) {
    //   throw new Error('学生不存在')
    // }

    // await this.repository.delete(id)
  }

  /**
   * 批量删除学生
   */
  async batchDelete(ids: string[]): Promise<number> {
    let count = 0
    for (const id of ids) {
      try {
        await this.deleteStudent(id)
        count++
      } catch (error) {
        console.error('删除学生失败:', id, error)
      }
    }
    return count
  }

  /**
   * 验证学生数据
   */
  validateStudent(data: CreateStudentDto): ValidationResult {
    const errors: string[] = []

    // 姓名验证
    if (!data.name || data.name.trim().length === 0) {
      errors.push('学生姓名不能为空')
    } else if (data.name.length > 50) {
      errors.push('学生姓名不能超过50个字符')
    }

    // 性别验证
    if (!data.gender || !['male', 'female'].includes(data.gender)) {
      errors.push('性别必须为 male 或 female')
    }

    // 联系方式验证（可选）
    if (data.contact && data.contact.length > 20) {
      errors.push('联系方式不能超过20个字符')
    }

    return {
      valid: errors.length === 0,
      errors
    }
  }

  /**
   * 批量导入学生
   */
  async importStudents(data: CreateStudentDto[]): Promise<ImportResult> {
    const result: ImportResult = {
      success: 0,
      failed: 0,
      errors: []
    }

    for (let i = 0; i < data.length; i++) {
      try {
        await this.addStudent(data[i])
        result.success++
      } catch (error) {
        result.failed++
        result.errors.push({
          row: i + 1,
          message: error instanceof Error ? error.message : '未知错误',
          data: data[i]
        })
      }
    }

    return result
  }
}
```

### 步骤 3: 创建 Pinia Store

#### 3.1 创建 `src/stores/student.ts`

```typescript
// src/stores/student.ts
import { defineStore } from 'pinia'
import type {
  Student,
  CreateStudentDto,
  UpdateStudentDto,
  StudentQueryParams
} from '@/types'

export const useStudentStore = defineStore('student', {
  state: () => ({
    students: [] as Student[],
    loading: false,
    currentStudent: null as Student | null,
    filters: {} as StudentQueryParams,
    pagination: {
      page: 1,
      pageSize: 20,
      total: 0
    }
  }),

  getters: {
    /**
     * 男生数量
     */
    maleCount: (state) =>
      state.students.filter(s => s.gender === 'male').length,

    /**
     * 女生数量
     */
    femaleCount: (state) =>
      state.students.filter(s => s.gender === 'female').length,

    /**
     * 特殊需求学生数量
     */
    specialNeedsCount: (state) =>
      state.students.filter(s => s.specialNeeds).length,

    /**
     * 总学生数量
     */
    totalCount: (state) => state.students.length
  },

  actions: {
    /**
     * 加载所有学生
     */
    async loadStudents() {
      this.loading = true
      try {
        // TODO: 调用 Repository
        // this.students = await studentRepository.findAll()
      } finally {
        this.loading = false
      }
    },

    /**
     * 添加学生
     */
    async addStudent(dto: CreateStudentDto) {
      // TODO: 调用 StudentManager
    },

    /**
     * 更新学生
     */
    async updateStudent(id: string, dto: UpdateStudentDto) {
      // TODO: 调用 StudentManager
    },

    /**
     * 删除学生
     */
    async deleteStudent(id: string) {
      // TODO: 调用 StudentManager
    },

    /**
     * 批量删除
     */
    async batchDelete(ids: string[]) {
      // TODO: 调用 StudentManager
    }
  }
})
```

### 步骤 4: 创建学生列表组件

#### 4.1 创建 `src/ui/components/student-list/StudentTable.vue`

```vue
<template>
  <v-data-table
    :headers="headers"
    :items="students"
    :loading="loading"
    :search="search"
    item-value="id"
    show-select
    v-model="selected"
  >
    <template v-slot:top>
      <v-toolbar flat>
        <v-toolbar-title>学生列表</v-toolbar-title>
        <v-divider class="mx-4" inset vertical></v-divider>
        <v-text-field
          v-model="search"
          append-icon="mdi-magnify"
          label="搜索"
          single-line
          hide-details
        ></v-text-field>
        <v-spacer></v-spacer>
        <v-btn color="primary" @click="openAddDialog">
          <v-icon left>mdi-plus</v-icon>
          添加学生
        </v-btn>
        <v-btn
          color="error"
          :disabled="selected.length === 0"
          @click="confirmBatchDelete"
        >
          <v-icon left>mdi-delete</v-icon>
          批量删除
        </v-btn>
      </v-toolbar>
    </template>

    <template v-slot:item.gender="{ item }">
      <v-chip :color="item.gender === 'male' ? 'blue' : 'pink'" size="small">
        {{ item.gender === 'male' ? '男' : '女' }}
      </v-chip>
    </template>

    <template v-slot:item.specialNeeds="{ item }">
      <v-icon v-if="item.specialNeeds" color="orange">
        mdi-star
      </v-icon>
    </template>

    <template v-slot:item.actions="{ item }">
      <v-icon size="small" class="me-2" @click="openEditDialog(item)">
        mdi-pencil
      </v-icon>
      <v-icon size="small" @click="confirmDelete(item)">
        mdi-delete
      </v-icon>
    </template>
  </v-data-table>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import { useStudentStore } from '@/stores/student'
import type { Student } from '@/types'

const studentStore = useStudentStore()

const search = ref('')
const selected = ref<string[]>([])

const headers = [
  { title: '姓名', key: 'name', align: 'start' },
  { title: '性别', key: 'gender', align: 'center' },
  { title: '年级', key: 'grade', align: 'start' },
  { title: '班级', key: 'className', align: 'start' },
  { title: '联系方式', key: 'contact', align: 'start' },
  { title: '特殊需求', key: 'specialNeeds', align: 'center' },
  { title: '操作', key: 'actions', align: 'end', sortable: false }
]

const students = computed(() => studentStore.students)
const loading = computed(() => studentStore.loading)

const openAddDialog = () => {
  // TODO: 打开添加对话框
}

const openEditDialog = (student: Student) => {
  // TODO: 打开编辑对话框
}

const confirmDelete = (student: Student) => {
  // TODO: 确认删除
}

const confirmBatchDelete = () => {
  // TODO: 确认批量删除
}
</script>
```

### 步骤 5: 创建学生表单组件

#### 5.1 创建 `src/ui/components/student-list/StudentForm.vue`

```vue
<template>
  <v-form ref="form" v-model="valid" @submit.prevent="handleSubmit">
    <v-text-field
      v-model="formData.name"
      label="姓名"
      :rules="nameRules"
      required
    ></v-text-field>

    <v-radio-group v-model="formData.gender" label="性别" row>
      <v-radio label="男" value="male"></v-radio>
      <v-radio label="女" value="female"></v-radio>
    </v-radio-group>

    <v-text-field
      v-model="formData.grade"
      label="年级"
    ></v-text-field>

    <v-text-field
      v-model="formData.className"
      label="班级"
    ></v-text-field>

    <v-text-field
      v-model="formData.contact"
      label="联系方式"
    ></v-text-field>

    <v-checkbox
      v-model="formData.specialNeeds"
      label="特殊需求"
    ></v-checkbox>

    <v-textarea
      v-model="formData.notes"
      label="备注"
      rows="3"
    ></v-textarea>

    <v-btn type="submit" color="primary" :disabled="!valid">
      保存
    </v-btn>
  </v-form>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import type { CreateStudentDto } from '@/types'

const emit = defineEmits<{
  submit: [dto: CreateStudentDto]
}>()

const valid = ref(false)
const form = ref()

const formData = ref<CreateStudentDto>({
  name: '',
  gender: 'male',
  specialNeeds: false
})

const nameRules = [
  (v: string) => !!v || '姓名不能为空',
  (v: string) => v.length <= 50 || '姓名不能超过50个字符'
]

const handleSubmit = () => {
  if (form.value.validate()) {
    emit('submit', formData.value)
  }
}
</script>
```

## 五、验收标准

### 必须满足（Must Have）
- [x] 学生 CRUD 功能正常
- [x] 姓名唯一性验证
- [x] 数据持久化到数据库
- [x] 列表展示和搜索

### 应该满足（Should Have）
- [x] 批量导入功能
- [x] 批量删除功能
- [x] 数据导出功能
- [x] 表单验证完整

### 可以满足（Nice to Have）
- [ ] 学生照片上传
- [ ] 高级过滤条件
- [ ] 数据统计图表

## 六、依赖关系

**前置任务**：
- [任务 002: 数据库设计与实现](./002-数据库设计任务.md)
- [任务 003: 核心类型定义](./003-核心类型定义任务.md)

**后续任务**：
- [任务 006: 座位填充引擎](./006-座位填充引擎.md)

---

**任务负责人**：待分配
**创建日期**：2025-12-27
**预计完成日期**：待定
**任务状态**：待开始
