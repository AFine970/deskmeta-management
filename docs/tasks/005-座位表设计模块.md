# 任务 005: 座位表设计模块

## 一、任务概述

**任务名称**：座位表设计模块
**优先级**：P0（核心功能）
**预估工作量**：8-10小时
**任务类型**：业务功能

## 二、任务目标

实现座位表的创建、编辑、预览和管理功能，支持自定义行列数、座位编号模式、功能区域标注等。

## 三、功能清单

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 创建座位表 | P0 | 设置行数、列数创建座位表 |
| 编辑座位表 | P0 | 修改座位表配置 |
| 座位网格展示 | P0 | 可视化展示座位布局 |
| 座位编号模式 | P0 | 连续编号/坐标编号切换 |
| 功能区域标注 | P1 | 标注前门/后门/讲台等 |
| 预设模板 | P1 | 提供2-8列常用布局 |
| 布局保存加载 | P1 | 保存和加载自定义布局 |
| 布局预览 | P1 | 实时预览座位表效果 |

## 四、核心文件结构

```
src/
├── core/
│   └── seat-manager.ts           # 座位管理器
├── repository/
│   └── layout.repository.ts      # 布局仓储
├── stores/
│   └── layout.ts                 # 座位表状态管理
└── ui/components/layout-designer/
    ├── SeatingGrid.vue           # 座位网格组件
    ├── FunctionalAreas.vue       # 功能区域组件
    ├── SeatEditor.vue            # 座位编辑器
    └── LayoutDesigner.vue        # 布局设计器主界面
```

## 五、核心代码实现

### 5.1 SeatManager（座位管理器）

```typescript
// src/core/seat-manager.ts
import type {
  LayoutConfig,
  Seat,
  CreateLayoutDto,
  LayoutValidationResult
} from '@/types'
import { v4 as uuidv4 } from 'uuid'

export class SeatManager {
  /**
   * 创建座位表布局
   */
  createLayout(dto: CreateLayoutDto): LayoutConfig {
    const now = new Date().toISOString()

    // 生成座位网格
    const seats: Seat[] = []
    for (let row = 0; row < dto.rows; row++) {
      for (let col = 0; col < dto.cols; col++) {
        const seat: Seat = {
          row,
          col,
          type: 'normal',
          id: `seat_${row}_${col}`
        }
        seats.push(seat)
      }
    }

    // 分配座位编号
    const layout: LayoutConfig = {
      id: uuidv4(),
      name: dto.name,
      rows: dto.rows,
      cols: dto.cols,
      seatNumberingMode: dto.seatNumberingMode || 'sequential',
      seats,
      functionalAreas: dto.functionalAreas,
      isDefault: false,
      createdAt: now,
      updatedAt: now
    }

    return this.assignSeatNumbers(layout)
  }

  /**
   * 分配座位编号
   */
  assignSeatNumbers(layout: LayoutConfig): LayoutConfig {
    if (layout.seatNumberingMode === 'sequential') {
      let number = 1
      // 按列从左到右，每列从后往前编号
      for (let col = 0; col < layout.cols; col++) {
        for (let row = layout.rows - 1; row >= 0; row--) {
          const seat = layout.seats.find(s => s.row === row && s.col === col)
          if (seat) {
            seat.displayNumber = String(number).padStart(2, '0')
            number++
          }
        }
      }
    }

    return layout
  }

  /**
   * 验证布局
   */
  validateLayout(layout: LayoutConfig): LayoutValidationResult {
    const errors: string[] = []
    const warnings: string[] = []

    // 验证行列范围
    if (layout.rows < 1 || layout.rows > 20) {
      errors.push('行数必须在1-20之间')
    }
    if (layout.cols < 1 || layout.cols > 20) {
      errors.push('列数必须在1-20之间')
    }

    // 验证座位数量
    const capacity = this.getCapacity(layout)
    if (capacity === 0) {
      errors.push('座位表至少需要一个座位')
    }

    return {
      valid: errors.length === 0,
      errors,
      warnings,
      capacity
    }
  }

  /**
   * 获取座位容量
   */
  getCapacity(layout: LayoutConfig): number {
    return layout.seats.filter(s => s.type === 'normal').length
  }

  /**
   * 查找座位
   */
  findSeat(layout: LayoutConfig, row: number, col: number): Seat | null {
    return layout.seats.find(s => s.row === row && s.col === col) || null
  }
}
```

### 5.2 SeatingGrid.vue（座位网格组件）

```vue
<template>
  <div class="seating-grid-container">
    <div
      class="seating-grid"
      :style="gridStyle"
    >
      <div
        v-for="seat in seats"
        :key="seat.id"
        :class="['seat', `seat-${seat.type}`, { selected: isSelected(seat) }]"
        @click="handleSeatClick(seat)"
      >
        <span v-if="showNumber" class="seat-number">
          {{ seat.displayNumber }}
        </span>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import type { LayoutConfig, Seat } from '@/types'

const props = defineProps<{
  layout: LayoutConfig
  showNumber?: boolean
  selectedSeats?: string[]
}>()

const emit = defineEmits<{
  seatClick: [seat: Seat]
}>()

const seats = computed(() => props.layout.seats)

const gridStyle = computed(() => ({
  display: 'grid',
  gridTemplateColumns: `repeat(${props.layout.cols}, 1fr)`,
  gap: '8px',
  padding: '20px'
}))

const isSelected = (seat: Seat) => {
  return props.selectedSeats?.includes(seat.id)
}

const handleSeatClick = (seat: Seat) => {
  emit('seatClick', seat)
}
</script>

<style scoped>
.seating-grid-container {
  width: 100%;
  height: 100%;
  overflow: auto;
}

.seating-grid {
  min-width: 600px;
  min-height: 400px;
}

.seat {
  aspect-ratio: 1;
  border: 2px solid #333;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s;
  background-color: white;
}

.seat:hover {
  background-color: #e3f2fd;
}

.seat.selected {
  background-color: #2196f3;
  color: white;
  border-color: #1976d2;
}

.seat-special {
  background-color: #fff3cd;
  border-color: #ffc107;
}
</style>
```

## 六、验收标准

- [x] 座位表创建和编辑功能
- [x] 座位网格可视化展示
- [x] 两种编号模式正常工作
- [x] 功能区域标注功能
- [x] 布局保存和加载

## 七、依赖关系

**前置任务**：
- [任务 002: 数据库设计与实现](./002-数据库设计任务.md)
- [任务 003: 核心类型定义](./003-核心类型定义任务.md)

**后续任务**：
- [任务 006: 座位填充引擎](./006-座位填充引擎.md)

---

**任务负责人**：待分配
**创建日期**：2025-12-27
**任务状态**：待开始
