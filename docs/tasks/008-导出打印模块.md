# 任务 008: 导出打印模块

## 一、任务概述

**任务名称**：导出打印模块
**优先级**：P1（重要功能）
**预估工作量**：4-6小时
**任务类型**：工具功能

## 二、任务目标

实现座位表的 PDF 导出和打印功能，支持高质量导出、页面设置、批量打印等。

## 三、功能清单

| 功能 | 优先级 | 说明 |
|------|--------|------|
| PDF 导出 | P1 | 导出高清 PDF 座位表 |
| 打印预览 | P1 | 预览打印效果 |
| 页面设置 | P1 | A4/A3纸张、横向/纵向 |
| 批量打印 | P2 | 打印多个班级座位表 |
| 图片导出 | P2 | 导出为 PNG/JPG 图片 |

## 四、核心实现

### 4.1 PDFExporter（PDF导出器）

```typescript
// src/utils/exporters.ts
import jsPDF from 'jspdf'
import html2canvas from 'html2canvas'

export interface ExportOptions {
  format?: 'pdf' | 'png' | 'jpeg'
  paperSize?: 'a4' | 'a3' | 'letter'
  orientation?: 'portrait' | 'landscape'
  quality?: number
  scale?: number
}

export class PDFExporter {
  /**
   * 导出座位表为 PDF
   */
  static async exportToPDF(
    elementId: string,
    filename: string = '座位表.pdf',
    options: ExportOptions = {}
  ): Promise<void> {
    const element = document.getElementById(elementId)
    if (!element) {
      throw new Error('元素未找到')
    }

    const {
      paperSize = 'a4',
      orientation = 'landscape',
      quality = 300,
      scale = 2
    } = options

    try {
      // 1. 转换为 Canvas
      const canvas = await html2canvas(element, {
        scale,
        backgroundColor: '#ffffff',
        logging: false,
        useCORS: true
      })

      // 2. 计算 PDF 尺寸
      const imgData = canvas.toDataURL('image/png', 1.0)
      const imgWidth = canvas.width
      const imgHeight = canvas.height

      // 3. 创建 PDF
      const pdf = new jsPDF({
        orientation: imgWidth > imgHeight ? 'landscape' : 'portrait',
        unit: 'px',
        format: this.getPaperSize(paperSize)
      })

      // 4. 添加图片到 PDF
      const pdfWidth = pdf.internal.pageSize.getWidth()
      const pdfHeight = (imgHeight * pdfWidth) / imgWidth

      pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight)
      pdf.save(filename)

    } catch (error) {
      console.error('导出 PDF 失败:', error)
      throw error
    }
  }

  /**
   * 导出为图片
   */
  static async exportToImage(
    elementId: string,
    filename: string,
    format: 'png' | 'jpeg' = 'png',
    quality: number = 1.0
  ): Promise<void> {
    const element = document.getElementById(elementId)
    if (!element) {
      throw new Error('元素未找到')
    }

    try {
      const canvas = await html2canvas(element, {
        scale: 2,
        backgroundColor: '#ffffff'
      })

      const link = document.createElement('a')
      link.download = filename
      link.href = canvas.toDataURL(`image/${format}`, quality)
      link.click()
    } catch (error) {
      console.error('导出图片失败:', error)
      throw error
    }
  }

  /**
   * 获取纸张尺寸
   */
  private static getPaperSize(size: string): [number, number] {
    const sizes: Record<string, [number, number]> = {
      a4: [297, 210],
      a3: [420, 297],
      letter: [279, 216]
    }
    return sizes[size] || sizes.a4
  }

  /**
   * 打印预览
   */
  static printPreview(elementId: string): void {
    const element = document.getElementById(elementId)
    if (!element) return

    const printWindow = window.open('', '_blank')
    if (!printWindow) return

    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
        <head>
          <title>打印预览</title>
          <style>
            body { margin: 0; padding: 20px; }
            @media print {
              body { margin: 0; }
            }
          </style>
        </head>
        <body>
          ${element.innerHTML}
        </body>
      </html>
    `)

    printWindow.document.close()
    printWindow.onload = () => {
      printWindow.print()
    }
  }
}
```

### 4.2 ExportDialog.vue（导出对话框组件）

```vue
<template>
  <v-dialog v-model="dialog" max-width="500px">
    <template v-slot:activator="{ props }">
      <v-btn v-bind="props" color="primary">
        <v-icon left>mdi-export</v-icon>
        导出
      </v-btn>
    </template>

    <v-card>
      <v-card-title>
        <span class="text-h5">导出座位表</span>
      </v-card-title>

      <v-card-text>
        <v-form>
          <!-- 导出格式 -->
          <v-select
            v-model="options.format"
            :items="formats"
            label="导出格式"
            prepend-icon="mdi-file"
          ></v-select>

          <!-- 纸张大小 -->
          <v-select
            v-model="options.paperSize"
            :items="paperSizes"
            label="纸张大小"
            prepend-icon="mdi-paper-size"
          ></v-select>

          <!-- 页面方向 -->
          <v-radio-group v-model="options.orientation" label="页面方向" row>
            <v-radio label="横向" value="landscape"></v-radio>
            <v-radio label="纵向" value="portrait"></v-radio>
          </v-radio-group>

          <!-- 文件名 -->
          <v-text-field
            v-model="filename"
            label="文件名"
            prepend-icon="mdi-file-outline"
          ></v-text-field>
        </v-form>
      </v-card-text>

      <v-card-actions>
        <v-spacer></v-spacer>
        <v-btn color="blue-darken-1" variant="text" @click="close">
          取消
        </v-btn>
        <v-btn color="blue-darken-1" variant="text" @click="preview">
          预览
        </v-btn>
        <v-btn color="blue-darken-1" variant="text" @click="export">
          导出
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { PDFExporter } from '@/utils/exporters'

const dialog = ref(false)
const filename = ref('座位表')

const options = ref({
  format: 'pdf',
  paperSize: 'a4',
  orientation: 'landscape'
})

const formats = [
  { title: 'PDF 文档', value: 'pdf' },
  { title: 'PNG 图片', value: 'png' },
  { title: 'JPEG 图片', value: 'jpeg' }
]

const paperSizes = [
  { title: 'A4 (297 x 210 mm)', value: 'a4' },
  { title: 'A3 (420 x 297 mm)', value: 'a3' },
  { title: 'Letter (279 x 216 mm)', value: 'letter' }
]

const close = () => {
  dialog.value = false
}

const preview = () => {
  PDFExporter.printPreview('seating-chart')
  close()
}

const export = async () => {
  try {
    const ext = options.value.format === 'pdf' ? 'pdf' : options.value.format
    const fullFilename = `${filename.value}.${ext}`

    if (options.value.format === 'pdf') {
      await PDFExporter.exportToPDF('seating-chart', fullFilename, options.value)
    } else {
      await PDFExporter.exportToImage('seating-chart', fullFilename, options.value.format as any)
    }

    close()
  } catch (error) {
    console.error('导出失败:', error)
    alert('导出失败，请重试')
  }
}
</script>
```

### 4.3 使用示例

```vue
<!-- 在页面中使用 -->
<template>
  <div id="seating-chart" class="seating-chart-export">
    <!-- 座位表内容 -->
    <SeatingGrid :layout="layout" />
    <FunctionalAreas :areas="layout.functionalAreas" />
  </div>

  <!-- 导出按钮 -->
  <ExportDialog />
</template>
```

## 五、验收标准

- [x] PDF 导出成功且清晰
- [x] 打印预览正常显示
- [x] 纸张大小和方向设置生效
- [x] 文件名自定义功能正常
- [x] 导出过程有加载提示
- [x] 错误处理完善

## 六、依赖关系

**前置任务**：
- [任务 003: 核心类型定义](./003-核心类型定义任务.md)
- [任务 005: 座位表设计模块](./005-座位表设计模块.md)

**后续任务**：无（最后的功能模块）

## 七、注意事项

1. **导出前隐藏不必要的元素**：使用 CSS `@media print` 控制打印时显示的内容
2. **图片质量和文件大小平衡**：scale 参数影响导出质量和文件大小
3. **跨域问题**：html2canvas 可能遇到跨域图片问题，需设置 `useCORS: true`
4. **大文件导出**：对于大型座位表，导出可能需要较长时间，需显示进度提示

---

**任务负责人**：待分配
**创建日期**：2025-12-27
**任务状态**：待开始
