# 任务 002: 数据库设计与实现

## 一、任务概述

**任务名称**：数据库设计与实现
**优先级**：P0（最高优先级）
**预估工作量**：3-4小时
**任务类型**：核心基础

## 二、任务目标

设计并实现基于 SQLite 的本地数据库系统，包括表结构设计、数据迁移、连接管理和 Repository 基础架构。

## 三、技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| better-sqlite3 | ^9.0.0 | SQLite 驱动（同步 API） |
| SQLite | 3.x | 关系型数据库 |
| TypeScript | ^5.0.0 | 类型安全 |

## 四、数据库设计

### 4.1 数据库表结构

#### 表 1: students（学生表）
```sql
CREATE TABLE students (
  id TEXT PRIMARY KEY,              -- UUID
  name TEXT UNIQUE NOT NULL,         -- 姓名（唯一）
  gender TEXT NOT NULL,              -- 性别：'male' | 'female'
  contact TEXT,                      -- 联系方式
  grade TEXT,                        -- 年级
  class_name TEXT,                   -- 班级
  special_needs INTEGER DEFAULT 0,   -- 特殊需求：0-否 1-是
  preferred_seat_id TEXT,            -- 优先座位ID（可选）
  notes TEXT,                        -- 备注信息
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_students_gender ON students(gender);
CREATE INDEX idx_students_class ON students(class_name);
CREATE INDEX idx_students_special_needs ON students(special_needs);
```

#### 表 2: layout_configs（座位表配置表）
```sql
CREATE TABLE layout_configs (
  id TEXT PRIMARY KEY,              -- UUID
  name TEXT NOT NULL,                -- 布局名称
  rows INTEGER NOT NULL,             -- 行数
  cols INTEGER NOT NULL,             -- 列数
  seat_numbering_mode TEXT NOT NULL DEFAULT 'sequential',  -- 编号模式
  layout_data TEXT NOT NULL,         -- JSON：座位配置
  functional_areas TEXT,             -- JSON：功能区域标注
  is_default INTEGER DEFAULT 0,      -- 是否默认布局
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_layouts_default ON layout_configs(is_default);
```

#### 表 3: seating_records（填充记录表）
```sql
CREATE TABLE seating_records (
  id TEXT PRIMARY KEY,              -- UUID
  layout_id TEXT NOT NULL,           -- 关联的布局ID
  fill_strategy TEXT NOT NULL,       -- 填充策略
  constraint_type TEXT,              -- 约束类型
  seating_data TEXT NOT NULL,        -- JSON：座位分配结果
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (layout_id) REFERENCES layout_configs(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_records_layout ON seating_records(layout_id);
CREATE INDEX idx_records_created ON seating_records(created_at DESC);
```

#### 表 4: app_settings（系统配置表）
```sql
CREATE TABLE app_settings (
  key TEXT PRIMARY KEY,              -- 配置键
  value TEXT NOT NULL,               -- 配置值（JSON字符串）
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 五、实施步骤

### 步骤 1: 安装数据库依赖

```bash
# 安装 better-sqlite3
npm install better-sqlite3

# 安装类型定义
npm install -D @types/better-sqlite3

# 验证安装
npm ls better-sqlite3
```

**注意**：better-sqlite3 需要原生编译，如果安装失败可能需要：
```bash
# Windows: 安装 Visual Studio Build Tools
# 或使用 npm install --ignore-scripts 跳过编译
```

### 步骤 2: 创建数据库连接管理

#### 2.1 创建 `src/database/connection.ts`

```typescript
// src/database/connection.ts
import Database from 'better-sqlite3'
import path from 'path'
import { app } from '@tauri-apps/api'
import { fs } from '@tauri-apps/api'

class DatabaseConnection {
  private static instance: Database.Database | null = null
  private static readonly DB_NAME = 'seating-system.db'

  /**
   * 获取数据库连接实例（单例模式）
   */
  static async getConnection(): Promise<Database.Database> {
    if (!this.instance) {
      await this.initialize()
    }
    return this.instance!
  }

  /**
   * 初始化数据库连接
   */
  private static async initialize(): Promise<void> {
    try {
      // 获取应用数据目录
      const appDataDir = await app.dataDir()

      // 确保目录存在
      const dbDir = appDataDir
      if (!await fs.exists(dbDir)) {
        await fs.createDir(dbDir, { recursive: true })
      }

      // 构建数据库路径
      const dbPath = path.join(dbDir, this.DB_NAME)

      // 创建数据库连接
      this.instance = new Database(dbPath)

      // 启用 WAL 模式（提升并发性能）
      this.instance.pragma('journal_mode = WAL')

      // 启用外键约束
      this.instance.pragma('foreign_keys = ON')

      // 运行数据库迁移
      await this.runMigrations()

      console.log('数据库初始化成功:', dbPath)
    } catch (error) {
      console.error('数据库初始化失败:', error)
      throw error
    }
  }

  /**
   * 运行数据库迁移
   */
  private static async runMigrations(): Promise<void> {
    if (!this.instance) {
      throw new Error('数据库连接未初始化')
    }

    // 创建迁移记录表
    this.instance.exec(`
      CREATE TABLE IF NOT EXISTS _migrations (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL UNIQUE,
        executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `)

    // 获取已执行的迁移
    const executedMigrations = this.instance
      .prepare('SELECT name FROM _migrations')
      .all() as { name: string }[]

    const executedSet = new Set(executedMigrations.map(m => m.name))

    // 执行未执行的迁移文件
    const migrations = [
      '001_initial.sql',
      '002_add_indexes.sql'
    ]

    for (const migration of migrations) {
      if (!executedSet.has(migration)) {
        console.log('执行迁移:', migration)

        // 读取迁移文件内容
        const migrationPath = path.join(__dirname, 'migrations', migration)
        const fs = require('fs')
        const sql = fs.readFileSync(migrationPath, 'utf-8')

        // 执行迁移
        this.instance.exec(sql)

        // 记录迁移
        this.instance
          .prepare('INSERT INTO _migrations (name) VALUES (?)')
          .run(migration)

        console.log('迁移完成:', migration)
      }
    }
  }

  /**
   * 关闭数据库连接
   */
  static close(): void {
    if (this.instance) {
      this.instance.close()
      this.instance = null
      console.log('数据库连接已关闭')
    }
  }

  /**
   * 重置数据库（仅用于开发/测试）
   */
  static async reset(): Promise<void> {
    this.close()
    const appDataDir = await app.dataDir()
    const dbPath = path.join(appDataDir, this.DB_NAME)

    const fs = require('fs')
    if (fs.existsSync(dbPath)) {
      fs.unlinkSync(dbPath)
      console.log('数据库已重置')
    }

    await this.initialize()
  }
}

export default DatabaseConnection
```

### 步骤 3: 创建数据库迁移文件

#### 3.1 创建 `src/database/migrations/001_initial.sql`

```sql
-- ============================================
-- 初始化数据库表结构
-- ============================================

-- 学生表
CREATE TABLE IF NOT EXISTS students (
  id TEXT PRIMARY KEY,
  name TEXT UNIQUE NOT NULL,
  gender TEXT NOT NULL CHECK(gender IN ('male', 'female')),
  contact TEXT,
  grade TEXT,
  class_name TEXT,
  special_needs INTEGER DEFAULT 0 CHECK(special_needs IN (0, 1)),
  preferred_seat_id TEXT,
  notes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 座位表配置表
CREATE TABLE IF NOT EXISTS layout_configs (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  rows INTEGER NOT NULL CHECK(rows > 0 AND rows <= 20),
  cols INTEGER NOT NULL CHECK(cols > 0 AND cols <= 20),
  seat_numbering_mode TEXT NOT NULL DEFAULT 'sequential' CHECK(seat_numbering_mode IN ('sequential', 'coordinate')),
  layout_data TEXT NOT NULL,
  functional_areas TEXT,
  is_default INTEGER DEFAULT 0 CHECK(is_default IN (0, 1)),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 填充记录表
CREATE TABLE IF NOT EXISTS seating_records (
  id TEXT PRIMARY KEY,
  layout_id TEXT NOT NULL,
  fill_strategy TEXT NOT NULL CHECK(fill_strategy IN ('random', 'manual', 'mixed')),
  constraint_type TEXT CHECK(constraint_type IN ('mixed_gender', 'same_gender', 'random')),
  seating_data TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (layout_id) REFERENCES layout_configs(id) ON DELETE CASCADE
);

-- 系统配置表
CREATE TABLE IF NOT EXISTS app_settings (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.2 创建 `src/database/migrations/002_add_indexes.sql`

```sql
-- ============================================
-- 添加索引以提升查询性能
-- ============================================

-- 学生表索引
CREATE INDEX IF NOT EXISTS idx_students_gender ON students(gender);
CREATE INDEX IF NOT EXISTS idx_students_class ON students(class_name);
CREATE INDEX IF NOT EXISTS idx_students_special_needs ON students(special_needs);

-- 布局配置表索引
CREATE INDEX IF NOT EXISTS idx_layouts_default ON layout_configs(is_default);

-- 填充记录表索引
CREATE INDEX IF NOT EXISTS idx_records_layout ON seating_records(layout_id);
CREATE INDEX IF NOT EXISTS idx_records_created ON seating_records(created_at DESC);
```

### 步骤 4: 创建 Repository 基类

#### 4.1 创建 `src/repository/base-repository.ts`

```typescript
// src/repository/base-repository.ts
import Database from 'better-sqlite3'
import DatabaseConnection from '../database/connection'

/**
 * Repository 基类
 * 提供通用的 CRUD 操作
 */
export abstract class BaseRepository<T extends { id: string }> {
  protected db: Database.Database
  protected tableName: string

  constructor(tableName: string) {
    this.tableName = tableName
    // 注意：这里需要延迟获取数据库连接
    // 实际使用时应该在子类构造函数中获取
    this.db = null as any
  }

  /**
   * 初始化数据库连接（由子类调用）
   */
  protected async initDb(): Promise<void> {
    this.db = await DatabaseConnection.getConnection()
  }

  /**
   * 根据 ID 查找实体
   */
  findById(id: string): T | null {
    const stmt = this.db.prepare(
      `SELECT * FROM ${this.tableName} WHERE id = ?`
    )
    const row = stmt.get(id) as any
    return row ? this.mapToEntity(row) : null
  }

  /**
   * 查找所有实体
   */
  findAll(): T[] {
    const stmt = this.db.prepare(`SELECT * FROM ${this.tableName}`)
    const rows = stmt.all() as any[]
    return rows.map(row => this.mapToEntity(row))
  }

  /**
   * 插入实体
   */
  insert(entity: Omit<T, 'id' | 'createdAt' | 'updatedAt'>): T {
    const id = this.generateId()
    const now = new Date().toISOString()

    const columns = Object.keys(entity as any)
    const values = Object.values(entity as any)
    const placeholders = columns.map(() => '?').join(', ')

    const sql = `
      INSERT INTO ${this.tableName} (id, ${columns.join(', ')}, created_at, updated_at)
      VALUES (?, ${placeholders}, ?, ?)
    `

    const stmt = this.db.prepare(sql)
    stmt.run(id, ...values, now, now)

    return this.findById(id)!
  }

  /**
   * 更新实体
   */
  update(id: string, updates: Partial<Omit<T, 'id' | 'createdAt' | 'updatedAt'>>): boolean {
    const columns = Object.keys(updates as any)
    if (columns.length === 0) return false

    const setClause = columns.map(col => `${col} = ?`).join(', ')
    const values = Object.values(updates as any)

    const sql = `
      UPDATE ${this.tableName}
      SET ${setClause}, updated_at = ?
      WHERE id = ?
    `

    const stmt = this.db.prepare(sql)
    const result = stmt.run(...values, new Date().toISOString(), id)

    return result.changes > 0
  }

  /**
   * 删除实体
   */
  delete(id: string): boolean {
    const stmt = this.db.prepare(`DELETE FROM ${this.tableName} WHERE id = ?`)
    const result = stmt.run(id)
    return result.changes > 0
  }

  /**
   * 生成唯一 ID
   */
  protected generateId(): string {
    return `${this.tableName}_${Date.now()}_${Math.random().toString(36).substring(2, 11)}`
  }

  /**
   * 将数据库行映射为实体（由子类实现）
   */
  protected abstract mapToEntity(row: any): T

  /**
   * 执行事务
   */
  protected runTransaction<R>(fn: () => R): R {
    const transaction = this.db.transaction(fn)
    return transaction()
  }
}
```

### 步骤 5: 创建种子数据

#### 5.1 创建 `src/database/seeds/001_demo_data.sql`

```sql
-- ============================================
-- 演示数据种子文件
-- ============================================

-- 插入演示学生
INSERT INTO students (id, name, gender, grade, class_name, special_needs) VALUES
('student_001', '张三', 'male', '高一', '1班', 0),
('student_002', '李四', 'male', '高一', '1班', 0),
('student_003', '王五', 'female', '高一', '1班', 0),
('student_004', '赵六', 'female', '高一', '1班', 0),
('student_005', '钱七', 'male', '高一', '1班', 1);

-- 插入默认布局配置
INSERT INTO layout_configs (id, name, rows, cols, seat_numbering_mode, layout_data, functional_areas, is_default) VALUES
('layout_001', '标准教室 8列8行', 8, 8, 'sequential',
 '{"seats": [
   {"row": 0, "col": 0, "type": "normal", "id": "seat_0_0"},
   {"row": 0, "col": 1, "type": "normal", "id": "seat_0_1"}
 ]}',
 '{"frontDoor": {"position": "bottom", "visible": true},
   "backDoor": {"position": "top", "visible": true},
   "podium": {"position": "bottom-center", "visible": true}}',
 1);

-- 插入系统配置
INSERT INTO app_settings (key, value) VALUES
('animation_speed', '{"value": 1000, "unit": "ms"}'),
('auto_save', '{"enabled": true}'),
('export_format', '{"format": "pdf", "dpi": 300}');
```

### 步骤 6: 创建数据库工具类

#### 6.1 创建 `src/database/seed.ts`

```typescript
// src/database/seed.ts
import Database from 'better-sqlite3'
import DatabaseConnection from './connection'
import path from 'path'
import fs from 'fs'

/**
 * 数据库种子数据管理器
 */
export class DatabaseSeeder {
  /**
   * 加载并执行种子文件
   */
  static async seed(seedFile: string): Promise<void> {
    const db = await DatabaseConnection.getConnection()

    const seedPath = path.join(__dirname, 'seeds', seedFile)

    if (!fs.existsSync(seedPath)) {
      console.warn('种子文件不存在:', seedPath)
      return
    }

    const sql = fs.readFileSync(seedPath, 'utf-8')

    console.log('加载种子数据:', seedFile)

    // 在事务中执行
    const transaction = db.transaction(() => {
      db.exec(sql)
    })

    transaction()

    console.log('种子数据加载完成')
  }

  /**
   * 清空所有数据（仅用于开发/测试）
   */
  static async clearAll(): Promise<void> {
    const db = await DatabaseConnection.getConnection()

    const transaction = db.transaction(() => {
      db.exec('DELETE FROM seating_records')
      db.exec('DELETE FROM layout_configs')
      db.exec('DELETE FROM students')
      db.exec('DELETE FROM app_settings')
    })

    transaction()

    console.log('所有数据已清空')
  }
}
```

### 步骤 7: 测试数据库连接

#### 7.1 创建 `src/database/test-connection.ts`

```typescript
// src/database/test-connection.ts
import DatabaseConnection from './connection'
import { DatabaseSeeder } from './seed'

/**
 * 测试数据库连接和基本操作
 */
export async function testDatabase(): Promise<void> {
  try {
    console.log('开始测试数据库...')

    // 1. 测试连接
    const db = await DatabaseConnection.getConnection()
    console.log('✓ 数据库连接成功')

    // 2. 测试查询
    const result = db.prepare('SELECT COUNT(*) as count FROM students').get() as { count: number }
    console.log(`✓ 当前学生数量: ${result.count}`)

    // 3. 测试种子数据
    // await DatabaseSeeder.seed('001_demo_data.sql')
    // console.log('✓ 种子数据加载成功')

    console.log('数据库测试完成')
  } catch (error) {
    console.error('数据库测试失败:', error)
    throw error
  }
}

// 在开发环境下运行测试
if (import.meta.env.DEV) {
  testDatabase()
}
```

### 步骤 8: 在应用启动时初始化数据库

#### 8.1 修改 `src/main.ts`

```typescript
import { createApp } from 'vue'
import App from './App.vue'
import router from './router'
import pinia from './stores'
import vuetify from './plugins/vuetify'
import DatabaseConnection from './database/connection'

// 注册 Vuetify 样式
import 'vuetify/styles'
import '@mdi/font/css/materialdesignicons.css'

// 初始化数据库
DatabaseConnection.getConnection().then(() => {
  console.log('数据库初始化完成')
}).catch(error => {
  console.error('数据库初始化失败:', error)
})

const app = createApp(App)

app.use(router)
app.use(pinia)
app.use(vuetify)

app.mount('#app')
```

## 六、验收标准

### 必须满足（Must Have）
- [x] 数据库连接成功创建
- [x] 所有表结构创建成功
- [x] 数据库迁移系统正常工作
- [x] Repository 基类实现完整
- [x] 事务支持正常工作

### 应该满足（Should Have）
- [x] 种子数据加载成功
- [x] 索引正确创建
- [x] 外键约束生效
- [x] 数据库连接池管理正常

### 可以满足（Nice to Have）
- [ ] 数据库性能测试
- [ ] 数据备份机制
- [ ] 数据库升级工具

## 七、依赖关系

**前置任务**：
- [任务 001: 项目初始化与脚手架搭建](./001-项目初始化任务.md)

**后续任务**：
- [任务 003: 核心类型定义](./003-核心类型定义任务.md)
- [任务 004: 学生信息管理模块](./004-学生信息管理模块.md)

## 八、风险与注意事项

### 8.1 常见问题

**问题 1: better-sqlite3 编译失败**
- 解决：安装 Visual Studio Build Tools（Windows）
- 备选：使用 `npm install --ignore-scripts`

**问题 2: 数据库文件路径权限问题**
- 解决：确保应用有权限访问 `app.dataDir()`

**问题 3: WAL 模式在网络上可能出现问题**
- 解决：本地数据库通常无此问题

### 8.2 性能优化建议

1. **批量操作使用事务**：减少磁盘 I/O
2. **合理使用索引**：提升查询性能
3. **定期 VACUUM**：回收数据库空间
4. **参数化查询**：防止 SQL 注入

## 九、参考文档

- [SQLite 官方文档](https://www.sqlite.org/docs.html)
- [better-sqlite3 文档](https://github.com/WiseLibs/better-sqlite3/blob/master/docs/api.md)
- [Repository 模式](https://martinfowler.com/eaaCatalog/repository.html)

## 十、附录

### 10.1 常用 SQL 命令

```sql
-- 查看表结构
.schema table_name

-- 查看所有表
.tables

-- 查看索引
.indexes

-- 执行查询分析
EXPLAIN QUERY SELECT ...

-- 导出数据库
.output backup.sql
.dump
```

### 10.2 调试技巧

```typescript
// 启用 SQL 日志
db.function('log', (sql: string) => {
  console.log('SQL:', sql)
})

// 查看数据库文件大小
const stats = fs.statSync(dbPath)
console.log('数据库大小:', (stats.size / 1024).toFixed(2), 'KB')
```

---

**任务负责人**：待分配
**创建日期**：2025-12-27
**预计完成日期**：待定
**任务状态**：待开始
