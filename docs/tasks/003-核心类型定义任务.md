# 任务 003: 核心类型定义

## 一、任务概述

**任务名称**：核心类型定义
**优先级**：P0（最高优先级）
**预估工作量**：2-3小时
**任务类型**：基础建设

## 二、任务目标

定义系统中所有的 TypeScript 类型和接口，为整个项目提供类型安全保障，确保代码的可维护性和可读性。

## 三、技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| TypeScript | ^5.0.0 | 类型系统 |
| Vue 3 | ^3.3.0 | Composition API 类型支持 |

## 四、类型定义清单

### 4.1 学生相关类型
### 4.2 座位表相关类型
### 4.3 填充相关类型
### 4.4 动画相关类型
### 4.5 工具类型
### 4.6 API 响应类型

## 五、实施步骤

### 步骤 1: 创建类型定义文件结构

```bash
# 创建类型目录
mkdir -p src/types

# 类型文件结构
src/types/
├── index.ts           # 统一导出所有类型
├── student.ts         # 学生相关类型
├── layout.ts          # 座位表相关类型
├── fill.ts            # 填充相关类型
├── animation.ts       # 动画相关类型
├── common.ts          # 通用类型
└── api.ts             # API 响应类型
```

### 步骤 2: 定义通用类型

#### 2.1 创建 `src/types/common.ts`

```typescript
// src/types/common.ts

/**
 * 性别类型
 */
export type Gender = 'male' | 'female'

/**
 * 性别显示标签
 */
export const GENDER_LABELS: Record<Gender, string> = {
  male: '男',
  female: '女'
}

/**
 * 座位类型
 */
export type SeatType = 'normal' | 'special'

/**
 * 座位编号模式
 */
export type SeatNumberingMode = 'sequential' | 'coordinate'

/**
 * 填充策略
 */
export type FillStrategy = 'random' | 'manual' | 'mixed'

/**
 * 约束类型
 */
export type ConstraintType = 'mixed_gender' | 'same_gender' | 'random'

/**
 * 位置类型
 */
export type Position =
  | 'top'
  | 'bottom'
  | 'left'
  | 'right'
  | 'top-center'
  | 'bottom-center'

/**
 * 基础实体接口（包含 ID 和时间戳）
 */
export interface BaseEntity {
  id: string
  createdAt: string
  updatedAt: string
}

/**
 * 分页参数
 */
export interface PaginationParams {
  page: number
  pageSize: number
}

/**
 * 分页响应
 */
export interface PaginationResponse<T> {
  data: T[]
  total: number
  page: number
  pageSize: number
  totalPages: number
}

/**
 * 验证结果
 */
export interface ValidationResult {
  valid: boolean
  errors: string[]
  warnings?: string[]
}

/**
 * 操作结果（用于 CRUD 操作）
 */
export interface OperationResult {
  success: boolean
  message?: string
  data?: any
}

/**
 * 导入结果
 */
export interface ImportResult {
  success: number
  failed: number
  errors: Array<{
    row: number
    message: string
    data: any
  }>
}
```

### 步骤 3: 定义学生相关类型

#### 3.1 创建 `src/types/student.ts`

```typescript
// src/types/student.ts
import type { BaseEntity, Gender } from './common'

/**
 * 学生实体
 */
export interface Student extends BaseEntity {
  /** 姓名（唯一） */
  name: string
  /** 性别 */
  gender: Gender
  /** 联系方式 */
  contact?: string
  /** 年级 */
  grade?: string
  /** 班级 */
  className?: string
  /** 特殊需求 */
  specialNeeds: boolean
  /** 优先座位ID */
  preferredSeatId?: string
  /** 备注信息 */
  notes?: string
}

/**
 * 创建学生 DTO
 */
export interface CreateStudentDto {
  name: string
  gender: Gender
  contact?: string
  grade?: string
  className?: string
  specialNeeds?: boolean
  preferredSeatId?: string
  notes?: string
}

/**
 * 更新学生 DTO
 */
export interface UpdateStudentDto {
  name?: string
  gender?: Gender
  contact?: string
  grade?: string
  className?: string
  specialNeeds?: boolean
  preferredSeatId?: string
  notes?: string
}

/**
 * 学生查询参数
 */
export interface StudentQueryParams {
  name?: string
  gender?: Gender
  grade?: string
  className?: string
  specialNeeds?: boolean
  keyword?: string
}

/**
 * 学生统计信息
 */
export interface StudentStats {
  total: number
  maleCount: number
  femaleCount: number
  specialNeedsCount: number
}
```

### 步骤 4: 定义座位表相关类型

#### 4.1 创建 `src/types/layout.ts`

```typescript
// src/types/layout.ts
import type { BaseEntity, SeatType, SeatNumberingMode, Position } from './common'

/**
 * 座位实体
 */
export interface Seat {
  /** 行索引（从 0 开始） */
  row: number
  /** 列索引（从 0 开始） */
  col: number
  /** 座位类型 */
  type: SeatType
  /** 座位 ID（系统内部使用） */
  id: string
  /** 显示编号（如 "01"、"02"） */
  displayNumber?: string
}

/**
 * 功能区域
 */
export interface FunctionalArea {
  /** 是否可见 */
  visible: boolean
  /** 位置 */
  position: Position
}

/**
 * 功能区域集合
 */
export interface FunctionalAreas {
  /** 前门 */
  frontDoor?: FunctionalArea
  /** 后门 */
  backDoor?: FunctionalArea
  /** 讲台 */
  podium?: FunctionalArea
  /** 窗户 */
  windows?: FunctionalArea
  /** 过道 */
  aisles?: Array<{
    row?: number
    col?: number
    type: 'horizontal' | 'vertical'
  }>
}

/**
 * 座位表布局配置
 */
export interface LayoutConfig extends BaseEntity {
  /** 布局名称 */
  name: string
  /** 行数 */
  rows: number
  /** 列数 */
  cols: number
  /** 座位编号模式 */
  seatNumberingMode: SeatNumberingMode
  /** 座位列表 */
  seats: Seat[]
  /** 功能区域标注 */
  functionalAreas?: FunctionalAreas
  /** 是否默认布局 */
  isDefault: boolean
}

/**
 * 创建布局 DTO
 */
export interface CreateLayoutDto {
  name: string
  rows: number
  cols: number
  seatNumberingMode?: SeatNumberingMode
  functionalAreas?: FunctionalAreas
}

/**
 * 更新布局 DTO
 */
export interface UpdateLayoutDto {
  name?: string
  rows?: number
  cols?: number
  seatNumberingMode?: SeatNumberingMode
  functionalAreas?: FunctionalAreas
  isDefault?: boolean
}

/**
 * 布局验证结果
 */
export interface LayoutValidationResult {
  valid: boolean
  errors: string[]
  warnings: string[]
  capacity: number
}
```

### 步骤 5: 定义填充相关类型

#### 5.1 创建 `src/types/fill.ts`

```typescript
// src/types/fill.ts
import type { BaseEntity, FillStrategy, ConstraintType } from './common'

/**
 * 座位分配
 */
export interface SeatAssignment {
  /** 座位 ID */
  seatId: string
  /** 学生 ID */
  studentId: string
}

/**
 * 填充记录
 */
export interface SeatingRecord extends BaseEntity {
  /** 关联的布局 ID */
  layoutId: string
  /** 填充策略 */
  fillStrategy: FillStrategy
  /** 约束类型（可选） */
  constraintType?: ConstraintType
  /** 座位分配结果 */
  assignments: SeatAssignment[]
}

/**
 * 填充选项
 */
export interface FillOptions {
  /** 是否忽略特殊需求学生 */
  ignoreSpecialNeeds?: boolean
  /** 是否覆盖已分配座位 */
  overwrite?: boolean
  /** 约束类型 */
  constraintType?: ConstraintType
  /** 随机种子（用于测试） */
  seed?: number
}

/**
 * 填充结果
 */
export interface FillResult {
  /** 填充记录 */
  record: SeatingRecord
  /** 成功分配的学生数量 */
  successCount: number
  /** 未分配的学生数量 */
  unassignedCount: number
  /** 验证结果 */
  validation: {
    valid: boolean
    errors: string[]
    warnings: string[]
  }
}

/**
 * 约束结果
 */
export interface ConstraintResult {
  /** 是否满足约束 */
  satisfied: boolean
  /** 违规信息 */
  violations: Array<{
    type: string
    message: string
    seats: string[]
  }>
  /** 可用学生列表 */
  availableStudents: string[]
}
```

### 步骤 6: 定义动画相关类型

#### 6.1 创建 `src/types/animation.ts`

```typescript
// src/types/animation.ts

/**
 * 动画配置
 */
export interface AnimationConfig {
  /** 每个座位的显示时长（毫秒） */
  speed: number
  /** 是否启用音效 */
  enableSound: boolean
  /** 每个座位随机滚动次数 */
  shuffleCount: number
  /** 动画缓动函数 */
  easing?: 'linear' | 'easeIn' | 'easeOut' | 'easeInOut'
}

/**
 * 动画帧
 */
export interface AnimationFrame {
  /** 座位 ID */
  seatId: string
  /** 学生姓名 */
  studentName: string
  /** 延迟时间（毫秒） */
  delay: number
  /** 帧类型 */
  type: 'shuffle' | 'final'
}

/**
 * 动画状态
 */
export type AnimationState = 'idle' | 'playing' | 'paused' | 'completed'

/**
 * 动画事件
 */
export interface AnimationEvent {
  type: 'start' | 'pause' | 'resume' | 'complete' | 'error'
  data?: any
}

/**
 * 动画进度
 */
export interface AnimationProgress {
  /** 当前帧索引 */
  currentFrame: number
  /** 总帧数 */
  totalFrames: number
  /** 已用时间（毫秒） */
  elapsedTime: number
  /** 总时长（毫秒） */
  totalTime: number
  /** 进度百分比（0-100） */
  percentage: number
}
```

### 步骤 7: 定义 API 响应类型

#### 7.1 创建 `src/types/api.ts`

```typescript
// src/types/api.ts
import type { Student, SeatingRecord, LayoutConfig } from './index'

/**
 * API 响应基础结构
 */
export interface ApiResponse<T = any> {
  code: number
  message: string
  data?: T
  timestamp: number
}

/**
 * 分页请求参数
 */
export interface PageRequest {
  page: number
  pageSize: number
  sortBy?: string
  sortOrder?: 'asc' | 'desc'
}

/**
 * 分页响应数据
 */
export interface PageResponse<T> {
  items: T[]
  total: number
  page: number
  pageSize: number
  totalPages: number
}

/**
 * 学生 API 响应
 */
export type StudentListResponse = PageResponse<Student>
export type StudentDetailResponse = Student

/**
 * 布局 API 响应
 */
export type LayoutListResponse = PageResponse<LayoutConfig>
export type LayoutDetailResponse = LayoutConfig

/**
 * 填充记录 API 响应
 */
export type SeatingRecordListResponse = PageResponse<SeatingRecord>
export type SeatingRecordDetailResponse = SeatingRecord

/**
 * 批量操作请求
 */
export interface BatchOperationRequest {
  ids: string[]
  operation: 'delete' | 'export' | 'update'
  data?: any
}

/**
 * 批量操作响应
 */
export interface BatchOperationResponse {
  success: number
  failed: number
  errors: Array<{
    id: string
    message: string
  }>
}
```

### 步骤 8: 创建统一导出文件

#### 8.1 创建 `src/types/index.ts`

```typescript
// src/types/index.ts

// 导出通用类型
export * from './common'

// 导出学生相关类型
export * from './student'

// 导出座位表相关类型
export * from './layout'

// 导出填充相关类型
export * from './fill'

// 导出动画相关类型
export * from './animation'

// 导出 API 响应类型
export * from './api'
```

### 步骤 9: 创建类型工具函数

#### 9.1 创建 `src/types/utils.ts`

```typescript
// src/types/utils.ts
import type { Student, LayoutConfig, SeatAssignment } from './index'

/**
 * 类型守卫：检查是否为学生对象
 */
export function isStudent(obj: any): obj is Student {
  return (
    obj &&
    typeof obj === 'object' &&
    typeof obj.id === 'string' &&
    typeof obj.name === 'string' &&
    typeof obj.gender === 'string'
  )
}

/**
 * 类型守卫：检查是否为布局配置对象
 */
export function isLayoutConfig(obj: any): obj is LayoutConfig {
  return (
    obj &&
    typeof obj === 'object' &&
    typeof obj.id === 'string' &&
    typeof obj.name === 'string' &&
    typeof obj.rows === 'number' &&
    typeof obj.cols === 'number' &&
    Array.isArray(obj.seats)
  )
}

/**
 * 类型守卫：检查是否为座位分配数组
 */
export function isSeatAssignmentArray(obj: any): obj is SeatAssignment[] {
  return (
    Array.isArray(obj) &&
    obj.every(
      item =>
        typeof item === 'object' &&
        typeof item.seatId === 'string' &&
        typeof item.studentId === 'string'
    )
  )
}

/**
 * 深度克隆对象
 */
export function deepClone<T>(obj: T): T {
  return JSON.parse(JSON.stringify(obj))
}

/**
 * 类型断言：确保值不为 null/undefined
 */
export function assertDefined<T>(value: T | null | undefined, message?: string): T {
  if (value === null || value === undefined) {
    throw new Error(message || 'Value is null or undefined')
  }
  return value
}

/**
 * 可选类型转必需类型
 */
export type RequireFields<T, K extends keyof T> = T & { [P in K]-?: T[P] }

/**
 * 部分类型转必需类型
 */
export type PartialBy<T, K extends keyof T> = Omit<T, K> & Partial<Pick<T, K>>
```

### 步骤 10: 添加类型注释示例

#### 10.1 在 Store 中使用类型

```typescript
// 示例：src/stores/student.ts
import { defineStore } from 'pinia'
import type { Student, CreateStudentDto } from '@/types'

export const useStudentStore = defineStore('student', {
  state: () => ({
    students: [] as Student[],
    loading: false,
    currentStudent: null as Student | null
  }),

  actions: {
    async addStudent(dto: CreateStudentDto): Promise<Student> {
      // 实现逻辑
    }
  }
})
```

#### 10.2 在组件中使用类型

```vue
<!-- 示例：src/ui/views/StudentManagement.vue -->
<script setup lang="ts">
import type { Student, CreateStudentDto } from '@/types'

const selectedStudent = ref<Student | null>(null)
const formData = ref<CreateStudentDto>({
  name: '',
  gender: 'male'
})
</script>
```

## 六、验收标准

### 必须满足（Must Have）
- [x] 所有核心类型定义完成
- [x] 类型导出正确
- [x] TypeScript 编译无错误
- [x] 类型注释完整

### 应该满足（Should Have）
- [x] 类型守卫函数实现
- [x] 工具类型函数实现
- [x] 类型测试文件

### 可以满足（Nice to Have）
- [ ] 类型文档生成（TypeDoc）
- [ ] 类型可视化工具
- [ ] 类型兼容性测试

## 七、依赖关系

**前置任务**：
- [任务 001: 项目初始化与脚手架搭建](./001-项目初始化任务.md)

**后续任务**：
- [任务 004: 学生信息管理模块](./004-学生信息管理模块.md)
- [任务 005: 座位表设计模块](./005-座位表设计模块.md)
- [任务 006: 座位填充引擎](./006-座位填充引擎.md)

## 八、最佳实践

### 8.1 类型定义原则

1. **单一职责**：每个类型文件只包含相关类型
2. **明确命名**：使用有意义的类型名称
3. **避免 any**：尽量不使用 `any` 类型
4. **类型复用**：使用泛型提高类型复用性
5. **导出管理**：统一从 `index.ts` 导出

### 8.2 TypeScript 配置优化

```json
// tsconfig.json
{
  "compilerOptions": {
    "strict": true,                    // 启用严格模式
    "noImplicitAny": true,             // 禁止隐式 any
    "strictNullChecks": true,          // 严格空值检查
    "strictFunctionTypes": true,       // 严格函数类型
    "noUnusedLocals": true,            // 检查未使用的局部变量
    "noUnusedParameters": true,        // 检查未使用的参数
    "exactOptionalPropertyTypes": true // 精确的可选属性类型
  }
}
```

### 8.3 类型安全示例

```typescript
// 好的做法：明确类型
function getStudentName(student: Student): string {
  return student.name
}

// 不好的做法：使用 any
function getStudentName(student: any): string {
  return student.name  // 运行时可能出错
}

// 好的做法：使用类型守卫
function printName(data: unknown) {
  if (isStudent(data)) {
    console.log(data.name)  // TypeScript 知道这是 Student
  }
}
```

## 九、参考文档

- [TypeScript 官方文档](https://www.typescriptlang.org/docs/)
- [Vue 3 TypeScript 支持](https://cn.vuejs.org/guide/typescript/overview.html)
- [TypeScript 类型体操](https://github.com/type-challenges/type-challenges)

## 十、附录

### 10.1 常用工具类型

```typescript
// Partial<T> - 将所有属性变为可选
type PartialStudent = Partial<Student>

// Required<T> - 将所有属性变为必需
type RequiredStudent = Required<PartialStudent>

// Readonly<T> - 将所有属性变为只读
type ReadonlyStudent = Readonly<Student>

// Pick<T, K> - 选择部分属性
type StudentBasic = Pick<Student, 'id' | 'name' | 'gender'>

// Omit<T, K> - 排除部分属性
type StudentWithoutNotes = Omit<Student, 'notes'>

// Record<K, T> - 创建对象类型
type StudentMap = Record<string, Student>
```

### 10.2 泛型最佳实践

```typescript
// API 响应包装器
interface ApiResponse<T> {
  code: number
  message: string
  data: T
}

// 使用示例
type StudentListResponse = ApiResponse<Student[]>
type StudentDetailResponse = ApiResponse<Student>

// Repository 基类
abstract class BaseRepository<T extends { id: string }> {
  abstract findById(id: string): T | null
  abstract findAll(): T[]
  abstract insert(entity: Omit<T, 'id'>): T
  abstract update(id: string, entity: Partial<T>): boolean
  abstract delete(id: string): boolean
}
```

---

**任务负责人**：待分配
**创建日期**：2025-12-27
**预计完成日期**：待定
**任务状态**：待开始
