# 任务 006: 座位填充引擎

## 一、任务概述

**任务名称**：座位填充引擎
**优先级**：P0（核心功能）
**预估工作量**：10-12小时
**任务类型**：核心算法

## 二、任务目标

实现座位填充的核心算法引擎，支持随机填充、手动填充、混合填充三种策略，并支持同桌约束规则。

## 三、功能清单

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 随机填充 | P0 | Fisher-Yates 洗牌算法 |
| 手动填充 | P0 | 拖拽学生到指定座位 |
| 混合填充 | P1 | 部分手动+部分随机 |
| 男女同桌约束 | P1 | 2人座1男1女，3人座至少1男1女 |
| 同性同桌约束 | P1 | 同性别分配 |
| 冲突检测 | P0 | 防止一学生多座位 |
| 特殊需求处理 | P1 | 优先分配特殊需求学生 |

## 四、核心算法实现

### 4.1 FillStrategyEngine（填充策略引擎）

```typescript
// src/core/fill-strategies.ts
import type {
  LayoutConfig,
  Student,
  SeatAssignment,
  SeatingRecord,
  FillOptions,
  FillResult
} from '@/types'
import { v4 as uuidv4 } from 'uuid'

export class FillStrategyEngine {
  /**
   * 随机填充算法（Fisher-Yates 洗牌）
   */
  randomFill(
    layout: LayoutConfig,
    students: Student[],
    options?: FillOptions
  ): FillResult {
    // 1. 过滤可用座位
    const availableSeats = layout.seats.filter(s => s.type === 'normal')

    if (availableSeats.length === 0) {
      return {
        record: this.createRecord(layout, 'random', [], undefined),
        successCount: 0,
        unassignedCount: students.length,
        validation: {
          valid: false,
          errors: ['没有可用的座位'],
          warnings: []
        }
      }
    }

    // 2. 分类学生
    const specialStudents = students.filter(s => s.specialNeeds)
    const normalStudents = students.filter(s => !s.specialNeeds)

    // 3. Fisher-Yates 洗牌
    const shuffledStudents = this.fisherYatesShuffle(normalStudents)

    // 4. 分配座位
    const assignments: SeatAssignment[] = []
    const remainingSeats = [...availableSeats]

    // 优先分配特殊需求学生
    for (const student of specialStudents) {
      if (remainingSeats.length === 0) break

      let seatIndex: number
      if (student.preferredSeatId) {
        seatIndex = remainingSeats.findIndex(s => s.id === student.preferredSeatId)
        if (seatIndex === -1) {
          seatIndex = Math.floor(Math.random() * remainingSeats.length)
        }
      } else {
        seatIndex = Math.floor(Math.random() * remainingSeats.length)
      }

      const seat = remainingSeats.splice(seatIndex, 1)[0]
      assignments.push({ seatId: seat.id, studentId: student.id })
    }

    // 分配普通学生
    const count = Math.min(shuffledStudents.length, remainingSeats.length)
    for (let i = 0; i < count; i++) {
      assignments.push({
        seatId: remainingSeats[i].id,
        studentId: shuffledStudents[i].id
      })
    }

    // 5. 创建填充记录
    const record = this.createRecord(layout, 'random', assignments, options?.constraintType)

    return {
      record,
      successCount: assignments.length,
      unassignedCount: students.length - assignments.length,
      validation: {
        valid: true,
        errors: [],
        warnings: assignments.length < students.length
          ? [`${students.length - assignments.length} 名学生未分配座位`]
          : []
      }
    }
  }

  /**
   * 手动填充
   */
  manualFill(
    layout: LayoutConfig,
    assignments: Map<string, string>
  ): FillResult {
    const assignmentArray: SeatAssignment[] = []

    for (const [seatId, studentId] of assignments.entries()) {
      assignmentArray.push({ seatId, studentId })
    }

    const record = this.createRecord(layout, 'manual', assignmentArray, undefined)

    return {
      record,
      successCount: assignmentArray.length,
      unassignedCount: 0,
      validation: {
        valid: true,
        errors: [],
        warnings: []
      }
    }
  }

  /**
   * Fisher-Yates 洗牌算法
   */
  private fisherYatesShuffle<T>(array: T[]): T[] {
    const result = [...array]
    for (let i = result.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1))
      ;[result[i], result[j]] = [result[j], result[i]]
    }
    return result
  }

  /**
   * 创建填充记录
   */
  private createRecord(
    layout: LayoutConfig,
    strategy: 'random' | 'manual' | 'mixed',
    assignments: SeatAssignment[],
    constraintType?: string
  ): SeatingRecord {
    return {
      id: uuidv4(),
      layoutId: layout.id,
      fillStrategy: strategy,
      constraintType: constraintType as any,
      assignments,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    }
  }
}
```

### 4.2 ConstraintEngine（约束引擎）

```typescript
// src/core/constraint-engine.ts
import type {
  LayoutConfig,
  Student,
  SeatAssignment,
  ConstraintType,
  ConstraintResult
} from '@/types'

export class ConstraintEngine {
  /**
   * 应用同桌约束
   */
  applyConstraints(
    layout: LayoutConfig,
    students: Student[],
    constraintType: ConstraintType
  ): ConstraintResult {
    switch (constraintType) {
      case 'mixed_gender':
        return this.applyMixedGender(layout, students)
      case 'same_gender':
        return this.applySameGender(layout, students)
      case 'random':
      default:
        return { satisfied: true, violations: [], availableStudents: students.map(s => s.id) }
    }
  }

  /**
   * 男女同桌约束
   */
  private applyMixedGender(
    layout: LayoutConfig,
    students: Student[]
  ): ConstraintResult {
    const males = students.filter(s => s.gender === 'male')
    const females = students.filter(s => s.gender === 'female')

    const violations: any[] = []

    // 按行检查
    for (let row = 0; row < layout.rows; row++) {
      const rowSeats = layout.seats.filter(s => s.row === row && s.type === 'normal')

      if (rowSeats.length === 2) {
        // 2人座：1男1女
        if (males.length === 0 || females.length === 0) {
          violations.push({
            type: 'row',
            message: `第 ${row + 1} 行无法满足男女同桌约束`,
            seats: rowSeats.map(s => s.id)
          })
        }
      }
    }

    return {
      satisfied: violations.length === 0,
      violations,
      availableStudents: students.map(s => s.id)
    }
  }

  /**
   * 同性同桌约束
   */
  private applySameGender(
    layout: LayoutConfig,
    students: Student[]
  ): ConstraintResult {
    // 实现同性同桌逻辑
    return {
      satisfied: true,
      violations: [],
      availableStudents: students.map(s => s.id)
    }
  }
}
```

## 五、验收标准

- [x] 随机填充算法正确实现
- [x] Fisher-Yates 洗牌无偏差
- [x] 手动拖拽填充正常工作
- [x] 同桌约束正确应用
- [x] 冲突检测机制有效
- [x] 特殊需求学生优先分配

## 六、依赖关系

**前置任务**：
- [任务 003: 核心类型定义](./003-核心类型定义任务.md)
- [任务 004: 学生信息管理模块](./004-学生信息管理模块.md)
- [任务 005: 座位表设计模块](./005-座位表设计模块.md)

**后续任务**：
- [任务 007: 动画演示模块](./007-动画演示模块.md)

---

**任务负责人**：待分配
**创建日期**：2025-12-27
**任务状态**：待开始
